# faultline

> Error tracking tool on AWS managed services.

![logo](https://faultline.github.io/faultline/faultline.png)

## Table of Contents

- [Concept](#concept)
- [Using framework](#using-framework)
- [How to deploy](#how-to-deploy)
- [Usage](#usage)
- [API](#api)
- [Web UI](#web-ui)
- [Destroy faultline](#destroy-faultline)
- [TODO](#todo)
- [Contribute](#contribute)
- [License](#license)

## Concept

- Simple deploy
- Manageless
- POST errors with config
- Between "Only mail notify" and "[Error tracking services](https://www.google.co.jp/search?q=error%20tracking%20service)"

## Using framework

- Serverless Framework :zap:

### AWS Resources

- AWS Lambda
- API Gateway
- Amazon S3
- Amazon DynamoDB
- IAM
- KMS (option)

## How to deploy

### Clone

```sh
$ git clone https://github.com/k1LoW/faultline.git
$ cd faultline
$ npm install
```

### Edit config

Copy [`config.default.yml`](config.default.yml) to `config.yml`. And edit.

### Deploy to AWS

```sh
$ AWS_PROFILE=XXxxXXX npm run deploy
```

## Usage

### POST errors to API

Example:

```sh
$ curl -X POST -H "x-api-key: xxxxXXXXXxXxXXxxXXXXXXXxxxxXXXXXX" -H "Content-Type: application/json" -d @sample-errors.json https://xxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/v0/projects/sample-project/errors
```

Sample errors POST JSON file is [here](sample-errors.json).

### Notififaction

#### :speech_balloon: Slack

POST errors with slack notification config like [this](sample-errors.json).

![slack](https://faultline.github.io/faultline/slack.png)

#### :octocat: GitHub issue

POST errors with GitHub repo config for creating issue, like following code

```json5
{
  "errors": [

   - snip -

  ],
  "notifications": [

    - snip -

    {
      "type": "github",
      "userToken": "XXXXXXXxxxxXXXXXXxxxxxXXXXXXXXXX",
      "owner": "k1LoW",
      "repo": "faultline",
      "labels": [
        "faultline", "bug"
      ],
      "if_exist": "reopen-and-comment",
      "notifyInterval": 10,
      "threshold": 1,
      "timezone": "Asia/Tokyo"
    }
  ]
}
```

![GitHub](https://faultline.github.io/faultline/github.png)

### :closed_lock_with_key: AWS KMS Encryption of `notifications` config

If you use faultline notifications on browser ( e.g [faultline-js](https://github.com/faultline/faultline-js) ), you should encrypt config.

#### :key: STEP 1. `useKms` option true

Set `useKms: true` in config.yml, and deploy. Default AWS KMS Key alias is `alias/faultline`.

#### :closed_lock_with_key: STEP 2. Encrypt notification config

Use `aws kms encrypt` command.

```sh
$ AWS_PROFILE=XXxxXXX aws kms encrypt --key-id alias/faultline --plaintext '{"type":"slack","endpoint":"https://hooks.slack.com/services/XXXXXXXX/XXXXXXXX/XXXxxXXXXXXxxxxXXXXXXX","channel":"#random","username":"faultline-notify","notifyInterval":5,"threshold":10}' --query CiphertextBlob --output text --region ap-northeast-1
XXXXXXxxxxXXXXXxxxxxxxxxxxxXXXXXXXXXXXXXxxxxxxxxxxxXXXXXxxxxxxxxXXXXxxxxxxxxXXXXXXXXXXXXxxxxx
```

OR

Use `/encrypt` API with apiKey (not clientApiKey).

```sh
$ curl -X POST -H "x-api-key:0123456789012345678901234567890" -H "Content-Type: application/json" https://xxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/v0/encrypt -d '{"type":"github","userToken":"XXXXXXXxxxxXXXXXXxxxxxXXXXXXXXXX","owner":"k1LoW","repo":"faultline","labels":["faultline","bug"],"if_exist":"reopen-and-comment","notifyInterval":10,"threshold":1,"timezone":"Asia/Tokyo"}'
{
  "status": "success",
  "encrypted": "ZZZZZZzzzzZZZZZzzzzzzzzzzzzZZZZZZZZZZZZZzzzzzzzzzzzZZZZZzzzzzzzzZZZZzzzzzzzzZZZZZZZZZZZZzzzzz"
}
```

#### :lock: STEP 3. Set encrypted text as `notifications` config

```json5
{
  "errors": [

   - snip -

  ],
  "notifications": [
    "XXXXXXxxxxXXXXXxxxxxxxxxxxxXXXXXXXXXXXXXxxxxxxxxxxxXXXXXxxxxxxxxXXXXxxxxxxxxXXXXXXXXXXXXxxxxx",
    "ZZZZZZzzzzZZZZZzzzzzzzzzzzzZZZZZZZZZZZZZzzzzzzzzzzzZZZZZzzzzzzzzZZZZzzzzzzzzZZZZZZZZZZZZzzzzz",
    {
      "type": "slack",
      "endpoint": "https://hooks.slack.com/services/XXXXXXXX/XXXXXXXX/XXXxxXXXXXXxxxxXXXXXXX",
      "channel": "#faultline-other-channel",
      "username": "faultline-notify",
      "notifyInterval": 10,
      "threshold": 1
    }
  ]
}
```

## API

[API Document](api.md) generated by [jdoc](https://github.com/r7kamura/jdoc).

JSON Hyper-Schema is [here](schema.json).

## Web UI

Sample web UI for faultline

https://github.com/faultline/faultline-webui

## Destroy faultline

1. Delete all projects (or Empty S3 bucket).
2. Run following command.

```sh
$ AWS_PROFILE=XXxxXXX npm run destroy
```

## TODO

- [ ] Refactor API response format
- [ ] Notification
    - [x] Slack
    - [x] GitHub Issue
    - [ ] ???
- [ ] Error Notify Filter
- [ ] API Gateway API Key (waiting CFn/Serverless "Usage plan" support. see [#2450](https://github.com/serverless/serverless/issues/2450) )

## Contribute

PRs accepted.

## License

MIT Â© Ken&#39;ichiro Oyama
